name: Deploy WireGuard

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install WireGuard
      run: sudo apt-get update && sudo apt-get install -y wireguard

    - name: Generate Server Keys
      run: |
        wg genkey | tee server_private.key | wg pubkey > server_public.key
        echo "::set-output name=server_private_key::$(cat server_private.key)"
        echo "::set-output name=server_public_key::$(cat server_public.key)"

    - name: Configure WireGuard
      run: |
        sudo bash -c 'cat << EOF > /etc/wireguard/wg0.conf
        [Interface]
        PrivateKey = ${{ steps.generate-keys.outputs.server_private_key }}
        Address = 10.0.0.1/24
        ListenPort = 51820

        [Peer]
        PublicKey = <client_public_key>
        AllowedIPs = 10.0.0.2/32
        EOF'
        
    - name: Start WireGuard
      run: sudo wg-quick up wg0
